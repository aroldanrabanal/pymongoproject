{% extends 'base.html' %}

{% block title %}Inicio{% endblock %}

{% block content %}
<section class="hero is-medium is-dark">
  <div class="hero-body has-text-centered">
    <div class="container">
      <h1 class="title is-1 mb-5">Rankings SAFA</h1>
      <h2 class="subtitle is-3 mb-6">Descubre y comparte los mejores videojuegos según la comunidad</h2>

      <div class="field has-addons is-centered">
        <div class="control is-expanded" style="max-width: 500px;">
          <input class="input is-medium" type="text" id="searchInput" placeholder="Buscar juego o categoría..." autocomplete="off">
        </div>
        <div class="control">
          <button class="button is-medium" id="clearSearch" style="display: none;">
            <span class="icon"><i class="fas fa-times"></i></span>
          </button>
        </div>
      </div>
      <div id="searchInfo" class="mt-3" style="display: none;">
        <span class="tag is-info is-light is-medium">
          <span id="searchResults"></span>
        </span>
      </div>
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <h2 class="title is-3 has-text-centered mb-6" id="sectionTitle">Juegos más valorados</h2>

    <div class="columns is-multiline is-variable is-4" id="gamesContainer">

      {% for juego in videojuegos %}
      <div class="column is-3 game-card"
           data-name="{{ juego.name|lower }}"
           data-categories="{% for tag in juego.cat_tags %}{{ tag.name|lower }}{% if not forloop.last %},{% endif %}{% endfor %}">
        <div class="card is-fullheight">
          <div class="card-image">
            <figure class="image is-4by3">
              <img src="{{ juego.image|default:'https://via.placeholder.com/400x300?text=Sin+Imagen' }}" alt="{{ juego.name }}">
            </figure>
          </div>
          <div class="card-content">
            <p class="title is-5">{{ juego.name }}</p>
            <p class="subtitle is-6 mb-2 mt-2">
              <strong>Valoraciones:</strong> {{ juego.reviews_count|default:0 }}
            </p>
            <p class="subtitle is-6 mb-2">
              <strong>Media:</strong>
              <span class="has-text-warning">
                {% for i in "12345"|make_list %}
                    {% if forloop.counter <= juego.avg_rating %}
                    <i class="fas fa-star"></i>
                  {% else %}
                    <i class="far fa-star"></i>
                  {% endif %}
                {% endfor %}
              </span>
              <span class="ml-2">({{ juego.avg_rating|default:"0.0" }})</span>
            </p>
              <div class="tags are-small mb-3">
              {% if juego.cat_tags %}
                {% for tag in juego.cat_tags %}
                  <span class="tag {{ tag.color }}">{{ tag.name }}</span>
                {% endfor %}
              {% else %}
                <span class="tag is-light">Sin categoría</span>
              {% endif %}
            </div>
            <p>{{ juego.desc|truncatewords:20 }}</p>
          </div>
          <footer class="card-footer">
            <a href="{% url 'game_detail' juego.code %}" class="card-footer-item">Ver juego</a>
          </footer>
        </div>
      </div>
      {% empty %}
      <div class="column is-12">
        <div class="notification is-warning has-text-centered">
          No hay videojuegos cargados actualmente.
          {% if user.is_staff %}
            <a href="{% url 'upload_json' %}">Sube un archivo JSON para empezar.</a>
          {% endif %}
        </div>
      </div>
      {% endfor %}

    </div>

    <!-- Mensaje cuando no hay resultados de búsqueda -->
    <div id="noResults" class="notification is-warning has-text-centered" style="display: none;">
      No se encontraron juegos que coincidan con tu búsqueda.
    </div>
  </div>
</section>

<section class="section has-background-dark has-text-light">
  <div class="container">
    <h2 class="title is-3 has-text-centered mb-6 has-text-light">Explora por categorías</h2>

    <div class="columns is-multiline is-centered is-variable is-3">
      <div class="column is-3">
        <div class="box has-text-centered has-background-grey-darker">
          <span class="icon is-large mb-3"><i class="fas fa-swords fa-2x"></i></span>
          <p class="title is-5">RPG</p>
          <p class="subtitle is-6">Historias épicas y progresión</p>
        </div>
      </div>
      <div class="column is-3">
        <div class="box has-text-centered has-background-grey-darker">
          <span class="icon is-large mb-3"><i class="fas fa-gun fa-2x"></i></span>
          <p class="title is-5">FPS</p>
          <p class="subtitle is-6">Acción rápida y táctica</p>
        </div>
      </div>
      <div class="column is-3">
        <div class="box has-text-centered has-background-grey-darker">
          <span class="icon is-large mb-3"><i class="fas fa-dungeon fa-2x"></i></span>
          <p class="title is-5">Metroidvania</p>
          <p class="subtitle is-6">Exploración y backtracking</p>
        </div>
      </div>
      <div class="column is-3">
        <div class="box has-text-centered has-background-grey-darker">
          <span class="icon is-large mb-3"><i class="fas fa-skull fa-2x"></i></span>
          <p class="title is-5">Survival Horror</p>
          <p class="subtitle is-6">Tensión y supervivencia</p>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const clearButton = document.getElementById('clearSearch');
    const searchInfo = document.getElementById('searchInfo');
    const searchResults = document.getElementById('searchResults');
    const sectionTitle = document.getElementById('sectionTitle');
    const gamesContainer = document.getElementById('gamesContainer');
    const noResults = document.getElementById('noResults');
    const gameCards = document.querySelectorAll('.game-card');

    function performSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();

        if (searchTerm === '') {
            showAllGames();
            return;
        }

        let visibleCount = 0;

        gameCards.forEach(card => {
            const gameName = card.getAttribute('data-name');
            const categories = card.getAttribute('data-categories');

            // Buscar en nombre o categorías
            if (gameName.includes(searchTerm) || categories.includes(searchTerm)) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        if (visibleCount === 0) {
            noResults.style.display = 'block';
            gamesContainer.style.display = 'none';
        } else {
            noResults.style.display = 'none';
            gamesContainer.style.display = '';
        }

        searchInfo.style.display = '';
        clearButton.style.display = '';
        sectionTitle.textContent = 'Resultados de búsqueda';

        const plural = visibleCount !== 1 ? 's' : '';
        searchResults.textContent = `"${searchInput.value}" - ${visibleCount} juego${plural} encontrado${plural}`;
    }

    function showAllGames() {
        gameCards.forEach(card => {
            card.style.display = '';
        });

        searchInfo.style.display = 'none';
        clearButton.style.display = 'none';
        noResults.style.display = 'none';
        gamesContainer.style.display = '';
        sectionTitle.textContent = 'Juegos más valorados';
    }

    function clearSearch() {
        searchInput.value = '';
        showAllGames();
        searchInput.focus();
    }

    searchInput.addEventListener('input', performSearch);

    clearButton.addEventListener('click', clearSearch);

    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            clearSearch();
        }
    });
});
</script>
{% endblock %}